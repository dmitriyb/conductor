project:
  name: differentia
  repository: https://github.com/dmitriyb/differentia.git

credentials:
  backend: rbw
  secrets:
    claude_token: { name: claude-oauth-token, env: CLAUDE_CODE_OAUTH_TOKEN }
    github_pat:   { name: differentia-pat,    env: AGENT_GH_TOKEN }

docker:
  base_image: debian:bookworm-slim
  dockerfile: Dockerfile.agent
  build_args: { ZIG_VERSION: "0.14.1" }

agents:
  implementer:
    prompt:
      system: roles/IMPLEMENTING.md
      task: "Implement GitHub issue #{{.IssueNumber}} from {{.RepoURL}}."
    workspace: rw
    output_schema: { pr_number: int, branch: string, status: string }
    tools: [gh, git]
  reviewer:
    prompt:
      system: roles/REVIEWING.md
      task: "Review PR #{{.PRNumber}} in {{.RepoOwner}}/{{.RepoName}}."
    workspace: ro
    output_schema: { status: string, comment_count: int, summary: string }

pipeline:
  - { name: implement, agent: implementer }
  - { name: review, agent: reviewer, depends_on: [implement] }
  - name: fix
    agent: implementer
    depends_on: [review]
    condition: "steps.review.output.status == 'changes_requested'"
